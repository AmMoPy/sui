const DB_NAME="MainDB",DB_VERSION=1,TEST_MODE=!0,elements={container:document.querySelector(".container"),playList:document.getElementById("playList"),playPauseBtn:document.getElementById("playPauseBtn"),prevBtn:document.getElementById("prevBtn"),nextBtn:document.getElementById("nextBtn"),uploadBtn:document.getElementById("uploadBtn"),fileUpload:document.getElementById("fileUpload"),selectAllBtn:document.getElementById("selectAllBtn"),deleteSelectedBtn:document.getElementById("deleteSelectedBtn")},state={audio:new Audio,currentIndex:0,currentAudioUrl:null,items:[],selectedItems:new Set};state.audio.addEventListener("ended",()=>{elements.playPauseBtn.textContent="▶",state.currentIndex<state.items.length-1&&setTimeout(()=>loadItem(state.currentIndex+1),1e3)});let db;async function verifyStorage(){if(navigator.storage&&navigator.storage.persist){let e=await navigator.storage.persist();e||console.warn("Storage not persistent - data may be cleared")}}const dbPromise=new Promise((e,t)=>{let n=indexedDB.open(DB_NAME,1);n.onblocked=()=>console.warn("DB blocked by other tabs"),n.onerror=t=>{console.error("DB error:",t.target.error);let n=indexedDB.open("TEMP_"+DB_NAME,1);n.onsuccess=()=>e(n.result)},n.onsuccess=t=>{console.log("DB initialized"),e(t.target.result)},n.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains("items")||t.createObjectStore("items",{keyPath:"id",autoIncrement:!0})}});async function debugDB(){let e=await dbPromise,t=e.transaction("items","readonly"),n=await new Promise(e=>{let n=t.objectStore("items").getAll();n.onsuccess=()=>e(n.result)});console.log("DB Contents:",n),console.log("Current Playlist:",state.items)}async function loadItems(e=!0){state.currentAudioUrl&&URL.revokeObjectURL(state.currentAudioUrl);try{let t=await dbPromise,n=await new Promise((e,n)=>{let a=t.transaction("items","readonly"),s=a.objectStore("items"),l=s.getAll();l.onsuccess=()=>e(l.result),l.onerror=()=>n(l.error)});state.items=[{name:"1",path:"assets/main/better_day.mp3"},{name:"2",path:"assets/main/care.mp3"},...n],renderplayList(),e&&state.items.length>0&&loadItem(0)}catch(a){console.error("Error loading playlist items:",a)}}async function handleFileUpload(e){let t=Array.from(e.target.files);if(t.length){showStatusMessage(`Uploading ${t.length} item(s)...`,"info");try{let n=await dbPromise;for(let a of t){let s=await new Promise((e,t)=>{let n=new FileReader;n.onload=()=>e(n.result),n.onerror=t,n.readAsArrayBuffer(a)});await new Promise((e,t)=>{let l=n.transaction("items","readwrite"),r=l.objectStore("items"),i=r.add({name:a.name.replace(/\.[^/.]+$/,""),data:s,timestamp:Date.now()});i.onsuccess=()=>e(),i.onerror=()=>t(i.error),l.oncomplete=()=>console.log("Transaction complete")})}showStatusMessage(`${t.length} item(s) uploaded successfully!`,"success"),await loadItems(!1),debugDB()}catch(l){console.error("Upload error:",l),showStatusMessage(`Upload failed: ${l.message}`,"error")}finally{e.target.value=""}}}function renderplayList(){elements.playList.innerHTML="",state.items.forEach((e,t)=>{let n=document.createElement("li");n.textContent=e.name,t===state.currentIndex&&n.classList.add("now-playing"),state.selectedItems.has(t)&&n.classList.add("selected"),n.addEventListener("mousedown",handleListItemMouseDown(t,n)),n.addEventListener("click",handleListItemClick(t,n)),n.addEventListener("touchstart",handleTouchStart(t,n),{passive:!0}),n.addEventListener("touchend",handleTouchEnd(t,n),{passive:!0}),elements.playList.appendChild(n)})}function handleListItemMouseDown(e,t){return function(e){(e.ctrlKey||e.metaKey||e.shiftKey)&&e.preventDefault()}}function handleListItemClick(e,t){return function(n){0===n.button&&(n.stopPropagation(),n.stopImmediatePropagation(),n.ctrlKey||n.metaKey||n.shiftKey?toggleSelection(e,t):playItem(e,t))}}function handleTouchStart(e,t){return function(n){t.touchStartTime=Date.now(),t.touchTimer=setTimeout(()=>{toggleSelection(e,t),t.classList.add("long-press")},500)}}function handleTouchEnd(e,t){return function(n){clearTimeout(t.touchTimer),!t.classList.contains("long-press")&&Date.now()-t.touchStartTime<200&&(n.preventDefault(),playItem(e,t)),t.classList.remove("long-press")}}function toggleSelection(e,t){state.selectedItems.has(e)?(state.selectedItems.delete(e),t.classList.remove("selected")):(state.selectedItems.add(e),t.classList.add("selected"))}function playItem(e,t){clearSelections(),loadItem(e),t.classList.add("selected"),state.selectedItems.add(e)}function clearSelections(){elements.playList.querySelectorAll("li").forEach(e=>{e.classList.remove("selected")}),state.selectedItems.clear()}function handleSelectAll(){state.selectedItems=new Set([...Array(state.items.length).keys()]),renderplayList()}async function handleDeleteSelected(){if(0!==state.selectedItems.size)try{let e=await dbPromise,t=e.transaction("items","readwrite"),n=t.objectStore("items"),a=Array.from(state.selectedItems).map(e=>state.items[e].id).filter(e=>e);await Promise.all(a.map(e=>new Promise(t=>{let a=n.delete(e);a.onsuccess=t}))),state.selectedItems=new Set,await loadItems(!1),alert(`${a.length} items deleted`)}catch(s){console.error("Delete failed:",s),alert("Error deleting items")}}function playPauseHandler(){if(state.audio.paused){let e=state.audio.play();elements.playPauseBtn.textContent="⏸",e.catch(e=>{console.error("Playback failed:",e),elements.playPauseBtn.textContent="▶"})}else state.audio.pause(),elements.playPauseBtn.textContent="▶"}function nextHandler(){let e=state.currentIndex+1;e<state.items.length&&loadItem(e)}function prevHandler(){let e=state.currentIndex-1;e>=0&&loadItem(e)}function handleVolumeKeys(e){("VolumeUp"===e.key||"VolumeDown"===e.key)&&(e.preventDefault(),"VolumeUp"===e.key?nextHandler():prevHandler(),elements.playPauseBtn.textContent="▶")}function initializeGestures(){let e=new Hammer.Manager(elements.container,{recognizers:[[Hammer.Swipe,{direction:Hammer.DIRECTION_HORIZONTAL}],[Hammer.Tap,{event:"singletap",taps:1,interval:250,time:250,threshold:9}]]});e.get("swipe").recognizeWith("singletap"),e.get("singletap").requireFailure("swipe"),e.on("singletap",e=>{e.target.closest("button, input, a")||playPauseHandler()}),e.on("swiperight",nextHandler),e.on("swipeleft",prevHandler)}function loadItem(e){if(e<0||e>=state.items.length)return;clearSelections(),state.currentAudioUrl&&(URL.revokeObjectURL(state.currentAudioUrl),state.currentAudioUrl=null),state.audio.pause(),state.currentIndex=e;let t=state.items[e];try{if(t.path)state.audio.src=t.path;else if(t.data){let n=new Blob([t.data],{type:"audio/mp3"});state.currentAudioUrl=URL.createObjectURL(n),state.audio.src=state.currentAudioUrl}else throw Error("Invalid playlist item");renderplayList();let a=state.audio.play();elements.playPauseBtn.textContent="⏸",a.catch(()=>elements.playPauseBtn.textContent="▶"),state.selectedItems.add(e);let s=elements.playList.querySelectorAll("li");s[e]&&s[e].classList.add("selected"),speakItemName(t.name)}catch(l){console.error("Playback failed:",l),elements.playPauseBtn.textContent="▶"}}function handleSongEnd(){elements.playPauseBtn.textContent="▶",state.currentIndex<state.items.length-1&&setTimeout(()=>loadItem(state.currentIndex+1),500)}function speakItemName(e){if("speechSynthesis"in window&&"SpeechSynthesisUtterance"in window){let t=new SpeechSynthesisUtterance(e);window.speechSynthesis.speak(t)}else console.log("Now playing:",e),showStatusMessage(`Now playing: ${e}`,"info")}function showStatusMessage(e,t="info"){let n=document.createElement("div");n.textContent=e,n.style.position="fixed",n.style.bottom="20px",n.style.left="20px",n.style.padding="10px 20px",n.style.borderRadius="5px",n.style.zIndex="1000","error"===t?(n.style.backgroundColor="#ff4444",n.style.color="white"):"success"===t?(n.style.backgroundColor="#4CAF50",n.style.color="white"):(n.style.backgroundColor="#2196F3",n.style.color="white"),document.body.appendChild(n),setTimeout(()=>{n.style.transition="opacity 0.5s",n.style.opacity="0",setTimeout(()=>n.remove(),500)},3e3)}function initializeEventListeners(){elements.playPauseBtn.addEventListener("click",playPauseHandler),elements.prevBtn.addEventListener("click",prevHandler),elements.nextBtn.addEventListener("click",nextHandler),window.addEventListener("keydown",handleVolumeKeys),elements.uploadBtn.addEventListener("click",()=>elements.fileUpload.click()),elements.fileUpload.addEventListener("change",handleFileUpload),elements.selectAllBtn.addEventListener("click",handleSelectAll),elements.deleteSelectedBtn.addEventListener("click",handleDeleteSelected),initializeGestures(),state.audio.addEventListener("ended",handleSongEnd)}async function initializeApp(){await verifyStorage(),await dbPromise,initializeEventListeners(),await loadItems(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js",{scope:"/"})}initializeApp();